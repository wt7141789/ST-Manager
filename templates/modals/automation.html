<!-- Ëá™Âä®ÂåñËßÑÂàôÁÆ°ÁêÜÂô® -->
<div x-show="showAutomationModal" x-data="automationModal" x-cloak class="modal-overlay z-modal-std"
    @click.self="closeModal()">
    <div class="modal-container automation-container" style="width: 1100px; height: 85vh;">

        <!-- Â∑¶‰æßÔºöËßÑÂàôÈõÜÂàóË°® -->
        <aside class="automation-sidebar custom-scrollbar">
            <!-- Â§¥ÈÉ®‰øùÊåÅ‰∏çÂèò -->
            <div
                class="p-3 border-b border-[var(--border-light)] flex justify-between items-center bg-[var(--bg-panel)]">
                <span class="font-bold text-sm">ËßÑÂàôÈõÜ</span>
                <div class="flex gap-1">
                    <button @click="$refs.importInput.click()" class="btn-secondary px-2 py-1 text-xs"
                        title="ÂØºÂÖ•ËßÑÂàôÈõÜ">üì•</button>
                    <button @click="createNewRuleSet()" class="btn-secondary px-2 py-1 text-xs" title="Êñ∞Âª∫">+ Êñ∞Âª∫</button>
                </div>
                <input type="file" x-ref="importInput" style="display:none" accept=".json"
                    @change="handleImportRuleSet">
            </div>

            <div
                class="px-3 py-2 border-b border-[var(--border-light)] bg-[var(--bg-sub)] text-xs flex justify-between items-center">
                <span class="text-[var(--text-dim)]">ÂÖ®Â±ÄËßÑÂàô:</span>
                <template x-if="globalRulesetId">
                    <span class="text-yellow-600 font-bold flex items-center gap-1">
                        ‚ö° <span x-text="ruleSets.find(r=>r.id===globalRulesetId)?.meta?.name || 'Êú™Áü•'"></span>
                    </span>
                </template>
                <template x-if="!globalRulesetId">
                    <span class="text-[var(--text-dim)]">Êú™ËÆæÁΩÆ (Á¶ÅÁî®)</span>
                </template>
            </div>

            <div class="flex-1 overflow-y-auto">
                <template x-for="rs in ruleSets" :key="rs.id">
                    <div class="ruleset-item" :class="activeRuleSet?.id === rs.id ? 'active' : ''"
                        @click="selectRuleSet(rs.id)">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-sm truncate" x-text="rs.meta.name || 'Êú™ÂëΩÂêçËßÑÂàôÈõÜ'"></span>

                            <!-- ‰øÆÂ§çÁÇπÔºöËøôÈáåÂéüÊù•ÈîôËØØÂú∞‰ΩøÁî®‰∫Ü activeRuleSet.idÔºåÊîπ‰∏∫ rs.id -->
                            <!-- ÂêåÊó∂Ê∑ªÂä† .stop ‰øÆÈ•∞Á¨¶Èò≤Ê≠¢Ëß¶ÂèëÁà∂Á∫ßÁÇπÂáª -->
                            <button @click.stop="toggleGlobalActive(rs.id)"
                                class="text-xs px-3 py-1 rounded border transition-all flex items-center gap-1" :class="globalRulesetId === rs.id 
                                    ? 'bg-yellow-500 text-black border-yellow-600 font-bold shadow-md' 
                                    : 'border-gray-500 text-gray-500 hover:border-yellow-500 hover:text-yellow-500'">
                                <span x-text="globalRulesetId === rs.id ? '‚ö° Â∑≤ÊøÄÊ¥ªÂÖ®Â±Ä' : '‚ö° ËÆæ‰∏∫ÂÖ®Â±Ä'"></span>
                            </button>
                        </div>
                        <div class="ruleset-meta flex justify-between">
                            <span x-text="'v' + (rs.meta.version || '1.0')"></span>
                            <span x-text="rs.rule_count + ' rules'"></span>
                        </div>
                    </div>
                </template>
                <div x-show="ruleSets.length===0" class="p-4 text-center text-xs text-[var(--text-dim)]">ÊöÇÊó†ËßÑÂàôÈõÜ</div>
            </div>
        </aside>

        <!-- Âè≥‰æßÔºöÁºñËæëÂô® -->
        <!-- ‰ΩøÁî® x-if Á°Æ‰øù activeRuleSet ‰∏∫Á©∫Êó∂‰∏çÊ∏≤ÊüìÂÜÖÈÉ® DOMÔºåÂΩªÂ∫ïÈÅøÂÖçÊä•Èîô -->
        <template x-if="activeRuleSet">
            <main class="automation-content">
                <!-- 1. È°∂ÈÉ®ÂÖÉÊï∞ÊçÆÊ†è -->
                <div class="auto-header flex-col items-stretch gap-2">

                    <!-- ÂÖ®Â±ÄÁä∂ÊÄÅÊèêÁ§∫Êù° -->
                    <div x-show="activeRuleSet?.id && globalRulesetId === activeRuleSet?.id"
                        class="bg-yellow-500/10 border border-yellow-500/30 rounded px-3 py-2 flex justify-between items-center transition-all duration-300">
                        <div class="flex items-center gap-2 text-yellow-600 font-bold text-xs">
                            <span class="text-lg">‚ö°</span>
                            <span>ÂΩìÂâçÁä∂ÊÄÅÔºöÂÖ®Â±ÄÈªòËÆ§ËßÑÂàô (ÂØºÂÖ•Êó∂Ëá™Âä®ËøêË°å)</span>
                        </div>
                        <button @click="toggleGlobalActive(activeRuleSet?.id)"
                            class="text-xs underline hover:text-yellow-500 cursor-pointer">
                            ÂÖ≥Èó≠ÂÖ®Â±ÄÁä∂ÊÄÅ
                        </button>
                    </div>

                    <div class="flex justify-between items-center w-full">
                        <div class="flex gap-4 items-center flex-1">
                            <div class="flex flex-col gap-1 flex-1">
                                <div class="flex items-center gap-2">
                                    <input type="text" x-model="editingMeta.name"
                                        class="text-lg font-bold bg-transparent border-b border-transparent hover:border-[var(--border-light)] focus:border-[var(--accent-main)] outline-none transition-colors flex-1"
                                        placeholder="ËßÑÂàôÈõÜÂêçÁß∞">

                                    <!-- ‰øÆÂ§çÁÇπÔºöÂ¢ûÂä† ?.id ÂÆâÂÖ®ËÆøÈóÆ -->
                                    <button @click="toggleGlobalActive(activeRuleSet?.id)"
                                        class="text-[10px] px-2 py-1 rounded border transition-colors whitespace-nowrap flex items-center gap-1"
                                        :class="(activeRuleSet?.id && globalRulesetId === activeRuleSet?.id)
                                            ? 'bg-yellow-500 text-black border-yellow-600 font-bold shadow-sm' 
                                            : 'border-[var(--border-light)] text-[var(--text-dim)] hover:border-yellow-500 hover:text-yellow-500'"
                                        :title="(activeRuleSet?.id && globalRulesetId === activeRuleSet?.id) ? 'ÁÇπÂáªÂÖ≥Èó≠ÂÖ®Â±Ä' : 'ËÆæ‰∏∫ÂÖ®Â±ÄËá™Âä®ËßÑÂàô'">
                                        <span>‚ö°</span>
                                        <span
                                            x-text="(activeRuleSet?.id && globalRulesetId === activeRuleSet?.id) ? 'Â∑≤ÊøÄÊ¥ª' : 'ËÆæ‰∏∫ÂÖ®Â±Ä'"></span>
                                    </button>
                                </div>
                                <input type="text" x-model="editingMeta.description"
                                    class="text-xs text-[var(--text-dim)] bg-transparent border-b border-transparent hover:border-[var(--border-light)] focus:border-[var(--accent-main)] outline-none w-full"
                                    placeholder="ÊèèËø∞...">
                            </div>
                            <div class="flex flex-col gap-1 w-24">
                                <input type="text" x-model="editingMeta.author" class="auto-input text-xs"
                                    placeholder="‰ΩúËÄÖ">
                                <input type="text" x-model="editingMeta.version" class="auto-input text-xs"
                                    placeholder="ÁâàÊú¨">
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button @click="exportCurrentRuleSet()" class="btn-secondary px-3" title="ÂØºÂá∫ JSON">
                                üì§
                            </button>
                            <button @click="deleteCurrentRuleSet()"
                                class="btn-secondary text-red-400 hover:text-red-500 px-3">Âà†Èô§</button>
                            <button @click="saveCurrentRuleSet()" class="btn-primary px-4 shadow-md">üíæ ‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>

                <!-- 2. ËßÑÂàôÂàóË°®ÊûÑÂª∫Âô® -->
                <div class="auto-body custom-scrollbar">

                    <template x-for="(rule, rIdx) in editingRules" :key="rule.id">
                        <div class="rule-card">
                            <!-- ËßÑÂàôÂ§¥ -->
                            <div class="rule-header">
                                <div class="flex items-center gap-2">
                                    <span class="drag-handle cursor-grab">‚ò∞</span>
                                    <input type="checkbox" x-model="rule.enabled" class="cursor-pointer" title="ÂêØÁî®/Á¶ÅÁî®">
                                    <input type="text" x-model="rule.name"
                                        class="bg-transparent font-bold text-sm outline-none border-b border-transparent hover:border-gray-500 focus:border-blue-500 w-64"
                                        placeholder="ËßÑÂàôÂêçÁß∞...">
                                </div>
                                <div class="flex items-center gap-3">
                                    <label class="flex items-center gap-1 text-xs cursor-pointer select-none"
                                        title="Â¶ÇÊûúÂëΩ‰∏≠Ê≠§ËßÑÂàôÔºå‰∏çÂÜçÊâßË°åÂêéÁª≠ËßÑÂàô">
                                        <input type="checkbox" x-model="rule.stop_on_match">
                                        <span class="text-[var(--text-dim)]">ÂëΩ‰∏≠Âç≥ÂÅúÊ≠¢</span>
                                    </label>
                                    <button @click="moveRule(rIdx, -1)" class="btn-icon-sm">‚ñ≤</button>
                                    <button @click="moveRule(rIdx, 1)" class="btn-icon-sm">‚ñº</button>
                                    <button @click="deleteRule(rIdx)" class="btn-icon-sm delete">üóëÔ∏è</button>
                                </div>
                            </div>

                            <!-- ËßÑÂàô‰Ωì -->
                            <div class="rule-body" x-show="rule.enabled">

                                <!-- IF Âå∫Âùó (Conditions) -->
                                <div class="logic-block">
                                    <div class="logic-label if flex flex-col items-end gap-1">
                                        <span>IF</span>
                                    </div>

                                    <div class="logic-content gap-3">
                                        <!-- Rule Level Logic (Group Connector) -->
                                        <div
                                            class="flex items-center gap-2 mb-2 p-2 bg-[var(--bg-sub)] rounded border border-[var(--border-light)]">
                                            <span class="text-xs font-bold text-[var(--text-dim)]">ËßÑÂàôÈÄªËæë:</span>
                                            <select x-model="rule.logic"
                                                class="bg-[var(--bg-panel)] border border-[var(--border-light)] rounded px-2 py-1 text-xs text-[var(--text-main)] outline-none cursor-pointer hover:border-[var(--accent-main)]"
                                                title="Â§ö‰∏™Êù°‰ª∂ÁªÑ‰πãÈó¥ÁöÑÂÖ≥Á≥ª">
                                                <option value="OR">Êª°Ë∂≥‰ªªÊÑè‰∏Ä‰∏™Êù°‰ª∂ÁªÑ (OR)</option>
                                                <option value="AND">ÂøÖÈ°ªÊª°Ë∂≥ÊâÄÊúâÊù°‰ª∂ÁªÑ (AND)</option>
                                            </select>
                                            <span class="text-xs text-[var(--text-dim)]">Êó∂Ëß¶ÂèëÂä®‰Ωú</span>
                                        </div>
                                        <!-- ÈÅçÂéÜ Groups -->
                                        <template x-for="(group, gIdx) in rule.groups" :key="group.id">
                                            <div
                                                class="relative border border-[var(--border-light)] rounded-lg p-2 bg-[var(--bg-sub)]">

                                                <!-- Group Header & Logic -->
                                                <div
                                                    class="flex justify-between items-center mb-2 pb-1 border-b border-[var(--border-light)] border-dashed">
                                                    <div class="flex items-center gap-2">
                                                        <span class="text-xs font-bold text-[var(--text-dim)]"
                                                            x-text="'Êù°‰ª∂ÁªÑ ' + (gIdx+1)"></span>
                                                        <select x-model="group.logic"
                                                            class="auto-select py-0 px-1 text-xs h-5">
                                                            <option value="AND">‰∏î (AND)</option>
                                                            <option value="OR">Êàñ (OR)</option>
                                                        </select>
                                                    </div>
                                                    <button @click="removeGroup(rIdx, gIdx)"
                                                        class="text-[10px] text-red-400 hover:text-red-500">Âà†Èô§ÁªÑ</button>
                                                </div>

                                                <!-- Conditions List -->
                                                <div class="flex flex-col gap-1">
                                                    <template x-for="(cond, cIdx) in group.conditions" :key="cIdx">
                                                        <div class="logic-row bg-[var(--bg-panel)]">
                                                            <!-- Â≠óÊÆµÈÄâÊã© -->
                                                            <select x-model="cond.field" class="auto-select w-32">
                                                                <optgroup label="Âü∫Á°Ä‰ø°ÊÅØ">
                                                                    <option value="char_name">ËßíËâ≤Âêç (Name)</option>
                                                                    <option value="creator">Âàõ‰ΩúËÄÖ (Creator)</option>
                                                                    <option value="char_version">ÁâàÊú¨ (Version)</option>
                                                                    <option value="tags">Ê†áÁ≠æ (Tags)</option>
                                                                </optgroup>

                                                                <optgroup label="Ê†∏ÂøÉÊñáÊú¨">
                                                                    <option value="description">ÁÆÄ‰ªã (Description)
                                                                    </option>
                                                                    <option value="first_mes">ÂºÄÂú∫ÁôΩ (First Mes)</option>
                                                                    <option value="alternate_greetings">Â§áÁî®ÂºÄÂú∫ÁôΩ (Alt
                                                                        Greetings)</option>
                                                                    <option value="mes_example">ÂØπËØùÁ§∫‰æã (Mes Example)
                                                                    </option>
                                                                </optgroup>

                                                                <optgroup label="ËÆæÂÆö‰∏éÊèêÁ§∫ËØç">
                                                                    <option value="personality">‰∫∫Ê†ºËÆæÂÆö (Personality)
                                                                    </option>
                                                                    <option value="scenario">Âú∫ÊôØËÆæÂÆö (Scenario)</option>
                                                                    <option value="creator_notes">‰ΩúËÄÖÊ≥®Èáä (Creator Notes)
                                                                    </option>
                                                                    <option value="system_prompt">Á≥ªÁªüÊèêÁ§∫ËØç (Sys Prompt)
                                                                    </option>
                                                                    <option value="post_history_instructions">ÂéÜÂè≤Êåá‰ª§ (Post
                                                                        History)</option>
                                                                </optgroup>

                                                                <optgroup label="È´òÁ∫ßÊâ©Â±ï">
                                                                    <option value="wi_name">‰∏ñÁïå‰π¶ÂêçÁß∞</option>
                                                                    <option value="wi_content">‰∏ñÁïå‰π¶ÂÜÖÂÆπ</option>
                                                                    <option value="regex_name">Ê≠£ÂàôËÑöÊú¨ÂêçÁß∞</option>
                                                                    <option value="regex_content">Ê≠£ÂàôËÑöÊú¨ÂÜÖÂÆπ</option>
                                                                    <option value="st_script_name">ST Helper ËÑöÊú¨Âêç
                                                                    </option>
                                                                    <option value="st_script_content">ST Helper ÂÜÖÂÆπ
                                                                    </option>
                                                                </optgroup>

                                                                <optgroup label="Á≥ªÁªüÂ±ûÊÄß">
                                                                    <option value="ui_summary">Êú¨Âú∞Â§áÊ≥® (Local Note)
                                                                    </option>
                                                                    <option value="source_link">Êù•Ê∫êÈìæÊé• (Source Link)
                                                                    </option>
                                                                    <option value="is_favorite">ÊòØÂê¶Êî∂Ëóè (Is Fav)</option>
                                                                    <option value="token_count">Token Êï∞</option>
                                                                    <option value="file_size">Êñá‰ª∂Â§ßÂ∞è</option>
                                                                </optgroup>
                                                            </select>

                                                            <!-- Êìç‰ΩúÁ¨¶ -->
                                                            <select x-model="cond.operator" class="auto-select w-28">
                                                                <option value="contains">ÂåÖÂê´</option>
                                                                <option value="not_contains">‰∏çÂåÖÂê´</option>
                                                                <option value="eq">Á≠â‰∫é</option>
                                                                <option value="neq">‰∏çÁ≠â‰∫é</option>
                                                                <option value="regex">Ê≠£ÂàôÂåπÈÖç</option>
                                                                <option value="exists">ÊúâÂÜÖÂÆπ</option>
                                                                <option value="not_exists">‰∏∫Á©∫</option>
                                                                <option value="gt">Â§ß‰∫é</option>
                                                                <option value="lt">Â∞è‰∫é</option>
                                                                <option value="is_true">ÊòØ (True)</option>
                                                                <option value="is_false">Âê¶ (False)</option>
                                                            </select>

                                                            <!-- ÂÄº -->
                                                            <div class="flex-1">
                                                                <input
                                                                    x-show="['exists','not_exists','is_true','is_false'].indexOf(cond.operator) === -1"
                                                                    type="text" x-model="cond.value"
                                                                    class="auto-input w-full">
                                                            </div>

                                                            <button @click="removeConditionFromGroup(rIdx, gIdx, cIdx)"
                                                                class="btn-icon-sm delete">‚úï</button>
                                                        </div>
                                                    </template>

                                                    <button @click="addConditionToGroup(rIdx, gIdx)"
                                                        class="text-xs text-left text-blue-400 hover:text-blue-300 w-fit mt-1">
                                                        + Ê∑ªÂä†Êù°‰ª∂
                                                    </button>
                                                </div>
                                            </div>
                                        </template>

                                        <button @click="addGroup(rIdx)"
                                            class="w-full py-1 text-xs border border-dashed border-[var(--border-light)] text-[var(--text-dim)] hover:border-blue-400 hover:text-blue-400 rounded transition">
                                            + Êñ∞Â¢ûÊù°‰ª∂ÁªÑ (New Group)
                                        </button>
                                    </div>
                                </div>

                                <!-- THEN Actions -->
                                <div class="logic-block">
                                    <div class="logic-label then">THEN</div>
                                    <div class="logic-content">
                                        <template x-for="(action, aIdx) in rule.actions" :key="aIdx">
                                            <div class="logic-row" style="border-color: rgba(16, 185, 129, 0.3);">
                                                <select x-model="action.type"
                                                    class="auto-select w-32 font-bold text-green-600">
                                                    <option value="move_folder">üìÇ ÁßªÂä®Âà∞...</option>
                                                    <option value="add_tag">üè∑Ô∏è Ê∑ªÂä†Ê†áÁ≠æ</option>
                                                    <option value="remove_tag">üóëÔ∏è ÁßªÈô§Ê†áÁ≠æ</option>
                                                    <option value="set_favorite">‚òÖ ËÆæ‰∏∫Êî∂Ëóè</option>
                                                </select>

                                                <div class="flex-1">
                                                    <template x-if="action.type === 'set_favorite'">
                                                        <select x-model="action.value" class="auto-select w-full">
                                                            <option value="true">ÊòØ (Favorite)</option>
                                                            <option value="false">Âê¶ (Unfavorite)</option>
                                                        </select>
                                                    </template>

                                                    <template x-if="action.type !== 'set_favorite'">
                                                        <input type="text" x-model="action.value"
                                                            class="auto-input w-full"
                                                            :placeholder="action.type==='move_folder' ? 'Êñá‰ª∂Â§πË∑ØÂæÑ (e.g. Race/Elf)' : 'Ê†áÁ≠æÂêçÁß∞'">
                                                    </template>
                                                </div>

                                                <button @click="removeAction(rIdx, aIdx)"
                                                    class="btn-icon-sm delete">‚úï</button>
                                            </div>
                                        </template>
                                        <button @click="addAction(rIdx)"
                                            class="text-xs text-left text-green-500 hover:text-green-400 w-fit">+
                                            Ê∑ªÂä†ÊâßË°åÂä®‰Ωú</button>
                                    </div>
                                </div>

                            </div>
                            <div x-show="!rule.enabled"
                                class="bg-[var(--bg-sub)] p-2 text-center text-xs text-[var(--text-dim)]">
                                (Ê≠§ËßÑÂàôÂ∑≤Á¶ÅÁî®)
                            </div>
                        </div>
                    </template>

                    <button @click="addRule()"
                        class="w-full py-3 border-2 border-dashed border-[var(--border-light)] rounded-lg text-[var(--text-dim)] hover:border-[var(--accent-main)] hover:text-[var(--accent-main)] transition font-bold">
                        + Êñ∞Â¢ûËßÑÂàô (New Rule)
                    </button>

                    <div class="h-10"></div> <!-- Bottom Spacer -->
                </div>
            </main>
        </template>

        <!-- Á©∫Áä∂ÊÄÅ -->
        <div x-show="!activeRuleSet" class="flex-1 flex flex-col items-center justify-center text-[var(--text-dim)]">
            <div class="text-6xl mb-4 opacity-20">‚ö°</div>
            <p>ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™ËßÑÂàôÈõÜÔºåÊàñÊñ∞Âª∫‰∏Ä‰∏™</p>
        </div>
    </div>
</div>